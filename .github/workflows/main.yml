name: "Build and Deploy"
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  Build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt;
    - name: Test with pytest
      run: |
        if [ -d tests ] || [ -d test ]; then OPENAI_API_KEY=${{secrets.OPENAI_API_KEY}} python -m pytest tests/tests.py; fi


  DeployDev:
    name: Deploy to Dev
    # if: github.event_name == 'pull_request'
    needs: [Build]
    runs-on: ubuntu-latest

    steps:

      - name: Check out code
        uses: actions/checkout@v2

      - name: Set permissions for private key
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Stop old container and build/run new Docker image
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{secrets.USER_NAME}}@${{secrets.HOST_NAME}} '
            set -e
            
            cd "$HOME/portfolio-qa-bot"
            
            # Stop and remove old container if running
            docker stop portfolio-qa-bot || true
            docker rm portfolio-qa-bot || true
            
            # Pull latest code
            git pull origin main
            
            # Build the Docker image
            docker build -t portfolio-qa-bot:latest .
            
            # Run the container
            docker run -d \
              --name portfolio-qa-bot \
              -p 8000:8000 \
              -e OPENAI_API_KEY=${{secrets.OPENAI_API_KEY}} \
              portfolio-qa-bot:latest
            
            # Verify container is running
            docker ps | grep portfolio-qa-bot
          '
